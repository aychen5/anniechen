---
title: "covid-19"
author: "Annie Chen"
date: "3/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, texreg, usmap, kableExtra)
```


Data is from Johns Hopkins
```{r}
browseURL("https://github.com/CSSEGISandData/COVID-19")

path <- "~/Dropbox/COVID-19/csse_covid_19_data/"
covid_conf <- read_csv(file.path(path,"csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"))
```


```{r}
glimpse(long_covid)

#wide to long data
long_covid <- covid_conf %>% 
  pivot_longer(cols = c(5:length(covid_conf)),
               names_to = c("date")) %>% 
  group_by(country = as_factor(`Country/Region`), date) 

long_covid[long_covid$country == "China",]
# summarize all the Chinese cases
long_covid %>% 
  #filter(country == "China")
  group_by(as_factor(`Country/Region`), date) %>% 
  summarize(mean)

# time series
long_covid %>% 
   filter(value >= 100) %>% 
ggplot() +
  geom_line(aes(x = date, y = log(value), 
                group = country, col = country)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#today
today <- unique(long_covid$date)[length(covid_conf)- 4]
today_lag1 <- unique(long_covid$date)[length(covid_conf) - 5]
long_covid %>% 
  filter(date == today) %>% 
  filter(value >= 100) %>% 
  ggplot() +
  geom_bar(aes(x = country, y = value, fill = country), 
           stat = "identity",
           alpha = 0.5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


### Individual-level data
- Measurement period: Jan 13 and Jan 31, 2020
```{r}
ind_cv <- read_csv("~/Dropbox/COVID-19/cv_reported_individual.csv")

ind_cv <- ind_cv %>% 
  mutate(female = if_else(gender == "female", 1, 0 ))
```

Survival Analysis on individual-level data

- This is interval-truncation?? (for some, we don't know date of onset -- prior to Dec. 17th; others survive beyond end of study period -- Jan. 31st)

```{r}
library(survminer)
library(survival)

# earliest exposure date in data is 17/12/2019
# assume this is our starting time and begin count from here
unique(ind_cv$exposure_start)

# first create vector of times (observation period is 46 days)
# 0 = DEC.17, 46 = JAN.31
df <- data.frame(dates = c(16:31, 1:31), 
                 count_date = 0:length(c(17:31, 1:31)))

# add survival days for those who died...
# looks like it's stored in the summary column
str_death <- str_extract(ind_cv$summary, "death on \\d+/\\d+/\\d+") %>% 
  str_extract("\\d+/\\d+/\\d+") %>% 
  lubridate::mdy() 
dday <- as.numeric(na.omit(str_extract(str_death, "[0-9][0-9]$")))

until <- list()
record <- vector()
for (i in dday){
  until[[i]] <- df[which(df$dates == i), "count_date"]
  if (!is.null(until[[i]]) & length(until[[i]]) <2){
    record[i] <- paste0(i, "-", until[[i]][1])
  } else if (!is.null(until[[i]]) & length(until[[i]]) ==2) {
    record[i] <- paste0(i, "-", until[[i]][2])
  }
}
#record

ind_cv <- ind_cv %>% 
  mutate(last_day = as.numeric(str_extract(str_death, "[0-9][0-9]$")),
         survtime = case_when(last_day == 9 ~ 24, 
                              last_day == 15 ~ 24, 
                              last_day == 18 ~ 33, 
                              last_day == 19 ~ 34, 
                              last_day == 20 ~ 35, 
                              last_day == 21 ~ 36,  
                              last_day == 22 ~ 37,  
                              last_day == 23 ~ 38,  
                              last_day == 24 ~ 39,
                              TRUE ~ max(df$count_date)))
 

cox_mod <- coxph(Surv(survtime, death, ) ~ age + female + from.Wuhan,
            data = ind_cv,
            method = "breslow")
screenreg(cox_mod)
```


Older folks are definitely more at risk, but it looks like survival probability is still relatively high.
```{r}
# age distribution
ggplot(ind_cv) +
  geom_density(aes(x = age), fill = "blue", alpha = 0.5) +
  theme_bw()
#fivenum(ind_cv$age)


new_data <- with(ind_cv, 
                 data.frame(female = c(0, 1), 
                            from.Wuhan = c(0, 1),
                            #first and third quartile
                            age = c(quantile(age, 0.25, na.rm = TRUE),
                                    quantile(age, 0.75, na.rm = TRUE))
                            ))

# survival curve
ggsurvplot(survfit(cox_mod, new_data), 
           data = ind_cv, conf.int = TRUE,
           ggtheme = theme_minimal())
```


Just the United States

```{r}
us_covid <- long_covid %>% 
  filter(country == "US") %>% 
  group_by(state = as_factor(`Province/State`))


#today (3/11/20)
us_covid %>% 
  filter(value > 10 & !str_detect(state, ", ")) %>% 
  filter(date == "3/11/20") %>% 
  ggplot() +
  geom_bar(aes(x = state, y = value, fill = state), 
           stat = "identity",
           alpha = 0.5)+
  labs(x = "State", y = "Number of confirmed cases") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# US map
us_covid_dat <- us_covid %>% 
  filter(date == today_lag1 & !str_detect(state, ", ")) %>% 
  mutate(fips = fips(state)) %>% 
  ungroup()%>% 
  select(fips, value) 


plot_usmap(data = us_covid_dat, values = "value", labels = TRUE) +
  theme(legend.title = element_blank())
```

Time trend?
```{r}
us_covid %>% 
  # don;t want the region
  filter(value != 0 & !str_detect(state, ", ")) %>% 
ggplot() +
  geom_line(aes(x = date, y = value, 
                group = state, col = state)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```



Top ten states:
```{r, results = 'asis'}
us_covid %>% 
  filter(date == today_lag1) %>% 
  select(state = state, cases = value) %>% 
  head(n = 10) %>% 
  kable(format = "markdown")
```




When are the primaries/conventions for each state?

Feb. 3 -- IOWA
FEB. 11 -- NEW HAMPSHIRE
Feb. 22 -- NEVADA
Mar. 3 -- ALABAMA, ARKANSAS, CALIFORNIA, COLORADO, MAINE, MASSACHUSETTS, MINNESOTA, NORTH CAROLINA, OKLAHOMA, TENNESSEE, TEXAS, UTAH, VERMONT
Mar. 10 -- IDAHO, MICHIGAN, MISSISSIPPI, MISSOURI, WASHINGTON
Mar. 17 -- FLORIDA, ILLINOIS, OHIO
Mar. 24 -- GEORGIA
Mar. 27-29 -- NORTH DAKOTA
Apr. 2-4 -- *ALASKA*
Apr. 4 -- LOUISIANA
Apr. 7 -- WISCONSIN
Apr. 28 -- CONNECTICUT, DELAWARE, MARYLAND, PENNSYLVANIA, RHODE ISLAND
May 1-2 -- *VIRGINIA*, *SOUTH CAROLINA*
May 5 -- INDIANA
May 9 -- ARIZONA, WYOMING
May 12 -- NEBRASKA, WEST VIRGINIA
May 19 -- KENTUCKY, OREGON
Jun. 2 -- MONTANA, NEW JERSEY, NEW MEXICO, SOUTH DAKOTA, DC
Jun. 7 -- PUERTO RICO

- *NEW YORK, KANSAS, NEVADA, HAWAII* cancels primaries


Am I able to create a synthetic control for each state...?

Considerations:
- SUTVA is likely violated.
- propensity score to predict similarity of states in order to construct donor pool?
    + but PS of what outcome?
- which state are we interested in?
    + Washington, which is the state with the greatest number of confirmed cases, has mail-in ballots
    + as does California
    + according to NYT:
        * "Americans have been increasingly voting by mail: More than 23 percent of voters cast their ballots by mail in the 2016 presidential elections, up from about 12 percent in 2004."
        * In the 2018 midterms, for example, states that permit voting by mail had, on average, a 15.5 percentage point higher turnout than states that did not. 
        * elections entirely by mail: Colorado, Hawaii, Oregon and Washington
        
- perhaps we still see a drop off in voting...least of people's concerns?

These are good resources
```{r}
resources <- list(
  # ACLU
  "https://www.aclu.org/news/voting-rights/keep-calm-and-carry-on-voting-how-to-vote-by-mail-during-the-coronavirus-outbreak/",
  # good map/chart that summarizes state of mail/absentee voting in each state
  "https://www.ncsl.org/research/elections-and-campaigns/absentee-and-early-voting.aspx",
  # NYT summary
  "https://www.nytimes.com/2020/03/12/opinion/coronavirus-election-vote-mail.html",
  # VOTER ID laws
  "https://ballotpedia.org/Voter_identification_laws_by_state"
)

# open all at once
lapply(resources, browseURL)
```




```{r}
library(Synth)

```


